<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿæ¯å‚³èªª - æ¸¬è©¦ç‰ˆ</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* (æ¨£å¼éƒ¨åˆ†ä¿æŒä¸Šä¸€å€‹ç‰ˆæœ¬ï¼Œå¢åŠ å¿«é€Ÿåˆ‡æ›åˆ—æ¨£å¼) */
        body { background-color: #121212; color: #e0e0e0; font-family: sans-serif; margin: 0; padding-bottom: 20px; text-align: center; }
        
        /* å¿«é€Ÿåˆ‡æ›åˆ— */
        .quick-switch-bar {
            display: flex; overflow-x: auto; background: #000; padding: 5px;
            border-bottom: 1px solid #333;
        }
        .qs-avatar {
            flex: 0 0 auto; width: 40px; height: 40px; border-radius: 50%;
            margin: 0 5px; border: 2px solid #555; display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; cursor: pointer; color: #fff;
        }
        .qs-avatar.RED { background: #b71c1c; }
        .qs-avatar.BLUE { background: #0d47a1; }
        .qs-avatar.active-turn { border-color: #ffca28; box-shadow: 0 0 8px #ffca28; transform: scale(1.1); }
        .qs-avatar.current-view { border-style: dashed; border-color: #fff; }

        /* å…¶ä»–æ¨£å¼æ²¿ç”¨... (ç•¥) */
        /* ç‚ºç¯€çœç¯‡å¹…ï¼Œè«‹ç›´æ¥ä½¿ç”¨ä¸Šä¸€ç‰ˆå®Œæ•´çš„ CSSï¼Œä¸¦è£œä¸Šä¸Šé¢é€™æ®µ .quick-switch-bar */
        .scoreboard { display: flex; justify-content: space-between; background: #1e1e1e; padding: 5px; }
        .team-box { width: 48%; padding: 5px; border: 1px solid #444; }
        .gem { display:inline-block; width:10px; height:10px; border-radius:50%; margin:1px; }
        .gem.red { background:#f44; } .gem.blue { background:#44f; }
        .card { display:inline-block; width:70px; height:96px; margin:4px; background:#eee; color:#333; border-radius:6px; font-weight:bold; line-height:96px; cursor:pointer; }
        .card.atk { background:#ffebee; border-bottom:4px solid #c62828; }
        .card.def { background:#e8f5e9; border-bottom:4px solid #2e7d32; }
        .card.magic { background:#e3f2fd; border-bottom:4px solid #1565c0; }
        .card.dark { background:#cfd8dc; border-bottom:4px solid #37474f; }
        #target-area { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); padding-top:50px; }
        .target-btn { display:block; width:90%; margin:10px auto; padding:15px; background:#333; color:white; border:1px solid #555; }
    </style>
</head>
<body>
    <div id="loading">é€£ç·šä¸­...</div>

    <!-- 1. å¿«é€Ÿåˆ‡æ›åˆ— (æ¸¬è©¦æ¨¡å¼å°ˆç”¨) -->
    <div id="quick-bar" class="quick-switch-bar" style="display:none;"></div>

    <div id="game-view" style="display:none;">
        <div class="scoreboard">
            <div class="team-box" style="border-color:#d32f2f">
                <span style="color:#ef5350">RED <span id="r-mor"></span></span>
                <div id="r-gems"></div>
            </div>
            <div class="team-box" style="border-color:#1976d2">
                <span style="color:#42a5f5">BLUE <span id="b-mor"></span></span>
                <div id="b-gems"></div>
            </div>
        </div>

        <div style="padding:10px; background:#252525; display:flex; justify-content:space-between;">
            <span id="p-name" style="font-weight:bold; color:#ffca28;"></span>
            <span id="turn-msg" style="color:#aaa; font-size:12px;"></span>
        </div>

        <div id="alert-box" style="display:none; padding:10px; margin:10px; background:#b71c1c; color:white; border-radius:5px;">
            <div id="alert-msg"></div>
            <button onclick="sendCmd('æ‰¿å—')" style="margin-top:5px; width:100%; padding:10px; border:none; background:#d32f2f; color:white; font-weight:bold;">ç›´æ¥æ‰¿å—</button>
        </div>

        <div id="draw-area" style="display:none; margin:10px;">
            <button onclick="sendCmd('@æ‘¸ç‰Œ')" style="width:100%; padding:20px; background:#ff9800; border:none; color:white; font-size:18px; border-radius:10px; animation: pulse 1s infinite;">
                ğŸ´ é»æ“Šæ‘¸ç‰Œ (å‰© <span id="draw-count"></span> å¼µ)
            </button>
        </div>
        
        <div id="discard-hint" style="display:none; padding:10px; background:#d32f2f; color:white;">
            âš ï¸ æ‰‹ç‰Œéå¤šï¼è«‹é»æ“Šå¡ç‰Œæ£„æ‰ <span id="disc-count"></span> å¼µ
        </div>

        <div id="hand-list" style="padding:5px;"></div>
        
        <div id="action-bar" style="display:flex; justify-content:space-around; padding:10px; background:#1a1a1a;">
            <button onclick="sendCmd('è³¼è²·')" style="width:30%; padding:10px;">è³¼è²·</button>
            <button onclick="sendCmd('åˆæˆ')" style="width:30%; padding:10px;">åˆæˆ</button>
            <button onclick="sendCmd('æç…‰')" style="width:30%; padding:10px;">æç…‰</button>
        </div>
    </div>

    <!-- ç›®æ¨™é¸å–® -->
    <div id="target-area">
        <h3 style="color:white;">é¸æ“‡ç›®æ¨™</h3>
        <div id="target-list"></div>
        <button onclick="document.getElementById('target-area').style.display='none'" style="margin-top:20px; padding:10px 30px;">å–æ¶ˆ</button>
    </div>

    <script>
        const LIFF_ID = "{{ liff_id }}";
        let currentSimulateId = null;
        let myData = null;
        let selectedCard = "";
        let actionType = "";

        async function main() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            // é¦–æ¬¡åŠ è¼‰å…ˆæŠ“åˆ—è¡¨
            fetch('/api/get_all_players').then(r=>r.json()).then(list => {
                if(list.length>0) {
                    currentSimulateId = list[0].id; // é è¨­é¸ç¬¬ä¸€ä½
                    fetchStatus();
                } else {
                    document.getElementById('loading').innerText = "è«‹å…ˆ @æ¸¬è©¦é–‹å±€";
                }
            });
        }

        function fetchStatus() {
            fetch('/api/my_status', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({simulate_id:currentSimulateId})})
            .then(r=>r.json()).then(d => {
                if(d.error) { alert(d.error); return; }
                myData = d;
                renderUI();
            });
        }

        function renderUI() {
            document.getElementById('loading').style.display='none';
            document.getElementById('game-view').style.display='block';
            document.getElementById('quick-bar').style.display='flex';

            // 1. æ¸²æŸ“å¿«é€Ÿåˆ‡æ›åˆ—
            const qb = document.getElementById('quick-bar');
            qb.innerHTML = '';
            myData.all_players.forEach(p => {
                let div = document.createElement('div');
                div.className = `qs-avatar ${p.team}`;
                div.innerText = p.name;
                if (p.id === myData.turn_owner_id) div.classList.add('active-turn'); // èª°çš„å›åˆ
                if (p.id === myData.my_id) div.classList.add('current-view'); // ç›®å‰è¦–è§’
                div.onclick = () => { currentSimulateId=p.id; fetchStatus(); };
                qb.appendChild(div);
            });

            // 2. æˆ°ç¸¾èˆ‡å€‹äºº
            document.getElementById('r-mor').innerText = myData.teams.RED.morale;
            document.getElementById('b-mor').innerText = myData.teams.BLUE.morale;
            renderGems('r-gems', myData.teams.RED.gems);
            renderGems('b-gems', myData.teams.BLUE.gems);
            document.getElementById('p-name').innerText = `${myData.name} (${myData.team})`;

            // 3. ç‹€æ…‹æ§åˆ¶
            const phase = myData.game_phase;
            const isMyTurn = myData.is_my_turn; // æ³¨æ„ï¼šé€™è£¡æ˜¯å¾Œç«¯åˆ¤æ–·éçš„ã€Œæ“ä½œæ¬Šã€
            
            document.getElementById('turn-msg').innerText = isMyTurn ? "â˜… è¼ªåˆ°ä½ äº†" : `ç­‰å¾… ${getPlayerName(myData.turn_owner_id)}...`;
            
            document.getElementById('draw-area').style.display = 'none';
            document.getElementById('discard-hint').style.display = 'none';
            document.getElementById('alert-box').style.display = 'none';
            document.getElementById('action-bar').style.display = 'none';

            if (isMyTurn) {
                if (phase === 'ACTION') {
                    document.getElementById('action-bar').style.display = 'flex';
                }
                else if (phase === 'DRAWING') {
                    document.getElementById('draw-area').style.display = 'block';
                    document.getElementById('draw-count').innerText = myData.pending_count;
                }
                else if (phase === 'DISCARDING') {
                    document.getElementById('discard-hint').style.display = 'block';
                    document.getElementById('disc-count').innerText = myData.pending_count;
                }
                else if (phase === 'CHOOSING_WEAKNESS') {
                     // é¡¯ç¤ºè™›å¼±é¸æ“‡æŒ‰éˆ•(ç•¥)
                }
            }

            // è¢«æ”»æ“Š
            const inc = myData.incoming_attack;
            if (inc && inc.target_id === myData.my_id) {
                document.getElementById('alert-box').style.display = 'block';
                let msg = inc.type==='missile' ? `âš ï¸ é­é­”å½ˆæ”»æ“Š (å‚·${inc.damage})` : `âš ï¸ é­ [${inc.card_name}] (${inc.element}) æ”»æ“Š`;
                document.getElementById('alert-msg').innerText = msg;
            }

            // æ‰‹ç‰Œ
            const hl = document.getElementById('hand-list'); hl.innerHTML='';
            myData.hand.forEach(c => {
                let d = document.createElement('div');
                let type='magic';
                if(c.includes('æ”»æ“Š')) type='atk';
                if(c.includes('æš—é»‘')) type='dark';
                if(c.includes('è–å…‰')||c.includes('é–ƒé¿')) type='def';
                d.className = `card ${type}`;
                d.innerText = c;
                d.onclick = () => onCardClick(c, phase, isMyTurn);
                hl.appendChild(d);
            });
        }

        // --- äº’å‹•é‚è¼¯ ---
        function onCardClick(card, phase, isMyTurn) {
            if (!isMyTurn) return;

            if (phase === 'DISCARDING') {
                if(confirm(`æ£„æ‰ [${card}]?`)) sendCmd(`æ£„ç‰Œ [${card}]`);
                return;
            }
            if (phase === 'DRAWING') { alert("è«‹é»æ©˜è‰²æŒ‰éˆ•æ‘¸ç‰Œ"); return; }

            // æ‡‰æˆ° (è¢«é–å®š)
            const inc = myData.incoming_attack;
            if (inc && inc.target_id === myData.my_id) {
                if (inc.type === 'missile') { /* é­”å½ˆé‚è¼¯ */ }
                else {
                    // æ™®é€šæ”»æ“Šæ‡‰æˆ°é åˆ¤
                    if (card === 'è–å…‰') {
                        if(confirm("è–å…‰æŠµéŠ·ï¼Ÿ")) sendCmd(`æ‡‰æˆ° [${card}]`);
                        return;
                    }
                    // æª¢æŸ¥å±¬æ€§ (ç°¡å–®ç‰ˆ)
                    let myElem = "none";
                    if(card.includes("ç«")) myElem="fire"; else if(card.includes("æ°´")) myElem="water";
                    else if(card.includes("é¢¨")) myElem="wind"; else if(card.includes("åœ°")) myElem="earth";
                    else if(card.includes("é›·")) myElem="thunder"; else if(card.includes("æš—")) myElem="dark";
                    
                    if (inc.element === 'dark') { alert("æš—å±¬æ€§ç„¡æ³•æ‡‰æˆ°"); return; }
                    if (myElem === inc.element || myElem === 'dark') {
                        if(confirm("æ‡‰æˆ°ä¸¦è½‰ç§»ï¼Ÿ")) showTargets('COUNTER', card);
                    } else {
                        alert("å±¬æ€§ä¸ç¬¦ (éœ€åŒå±¬æ€§æˆ–æš—å±¬æ€§)");
                    }
                }
                return;
            }

            // ä¸»å‹•å‡ºç‰Œ
            if (phase === 'ACTION') {
                if (card.includes('æ”»æ“Š')||card.includes('æš—é»‘')) showTargets('ATTACK', card);
                else if (['è–ç›¾','ä¸­æ¯’','è™›å¼±'].includes(card)) showTargets('ANY', card);
                else if (card==='é­”å½ˆ') sendCmd(`æ‰“å‡ºäº† [${card}]`);
                else alert("æ­¤ç‰Œç„¡æ³•ä¸»å‹•ä½¿ç”¨");
            }
        }

        function showTargets(mode, card) {
            selectedCard = card; actionType = mode;
            document.getElementById('target-area').style.display='block';
            const list = document.getElementById('target-list'); list.innerHTML='';
            
            let filter = p => true;
            if(mode==='ATTACK') filter = p => p.team !== myData.team;
            if(mode==='COUNTER') {
                let src = myData.incoming_attack ? myData.incoming_attack.source_name : "";
                filter = p => p.team !== myData.team && p.name !== src;
            }

            myData.all_players.filter(filter).forEach(p => {
                let b = document.createElement('div');
                b.className = 'target-btn'; 
                b.style.cssText = "padding:15px; margin:5px; background:#333; color:white; border:1px solid #555;";
                b.innerText = `${p.name} (${p.team})`;
                b.onclick = () => {
                    let cmd = "";
                    if(mode==='ATTACK') cmd = `æ‰“å‡ºäº† [${card}] æ”»æ“Š ${p.name}`;
                    if(mode==='ANY') cmd = `æ‰“å‡ºäº† [${card}] å° ${p.name}`;
                    if(mode==='COUNTER') cmd = `æ‡‰æˆ° [${card}] å° ${p.name}`;
                    sendCmd(cmd);
                };
                list.appendChild(b);
            });
        }

        function sendCmd(text) {
            // ç™¼é€æ ¼å¼ï¼š [åå­—] æŒ‡ä»¤
            // ç¯„ä¾‹ï¼š [ç´…1] è³¼è²·
            // ç¯„ä¾‹ï¼š [ç´…1] æ‰“å‡ºäº† [ç«æ”»æ“Š] æ”»æ“Š è—1
            const prefix = `[${myData.name}] `;
            
            // ç¢ºä¿ä¸é‡è¤‡æ·»åŠ å‰ç¶´ (å¦‚æœ text å·²ç¶“æœ‰å‰ç¶´)
            let finalMsg = text;
            if (!text.startsWith("[")) {
                finalMsg = prefix + text;
            }
    
            liff.sendMessages([{ type: 'text', text: finalMsg }])
                .then(() => {
                    closeTarget();
                    // åˆ·æ–°é é¢ä»¥æ›´æ–°ç‹€æ…‹ (å› ç‚ºå¯èƒ½ç‹€æ…‹é‚„æ²’è®Šï¼Œä½†ç‚ºäº†æµæš¢æ„Ÿ)
                    setTimeout(fetchStatus, 500); 
                    // liff.closeWindow(); // æ¸¬è©¦æœŸé–“å»ºè­°ä¸è¦é—œé–‰è¦–çª—ï¼Œæ–¹ä¾¿é€£çºŒæ“ä½œ
                })
                .catch(err => {
                    alert("ç™¼é€å¤±æ•—: " + err);
                });
        }
    </script>
</body>
</html>