<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿæ¯å‚³èªª - æˆ°å ´</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        body { 
            background-color: #1a1a1a; 
            color: #eee; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; padding: 0;
            text-align: center;
            user-select: none; /* é˜²æ­¢é€£é»é¸å–æ–‡å­— */
        }
        h3 { margin: 10px 0; font-weight: normal; color: #ffcc00; }
        
        /* --- ç™»å…¥/é¸è§’ä»‹é¢ --- */
        #login-view { padding: 20px; }
        .role-btn {
            display: block; width: 100%; padding: 15px; margin: 10px 0;
            background: #333; border: 1px solid #555; color: white;
            font-size: 18px; border-radius: 8px; cursor: pointer;
            text-align: left; padding-left: 20px;
        }
        .role-btn:active { background: #555; }
        .role-btn.RED { border-left: 10px solid #d32f2f; }
        .role-btn.BLUE { border-left: 10px solid #1976d2; }

        /* --- éŠæˆ²ä¸»ä»‹é¢ --- */
        #game-view { display: none; padding-bottom: 20px; }
        
        /* 1. é ‚éƒ¨æˆ°ç¸¾æ¿ */
        .scoreboard { 
            display: flex; justify-content: space-between; 
            background: #000; padding: 5px 10px; font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .team-stat { width: 48%; padding: 5px; border-radius: 4px; }
        .team-stat.RED { background: rgba(211, 47, 47, 0.2); border: 1px solid #d32f2f; }
        .team-stat.BLUE { background: rgba(25, 118, 210, 0.2); border: 1px solid #1976d2; }
        
        .gem-container { height: 16px; margin-top: 2px; }
        .gem { 
            display: inline-block; width: 12px; height: 12px; 
            border-radius: 50%; margin-right: 2px; border: 1px solid #fff;
        }
        .gem.red { background: #f44; box-shadow: 0 0 4px #f00; }
        .gem.blue { background: #44f; box-shadow: 0 0 4px #00f; }

        /* 2. å€‹äººç‹€æ…‹åˆ— */
        .status-bar {
            padding: 10px; background: #2d2d2d; 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #444;
        }
        .switch-btn { background: #444; color: #ccc; border: none; padding: 5px 10px; border-radius: 4px; }
        
        /* 3. è­¦å‘Šèˆ‡æç¤ºå€ */
        #alert-box { 
            display: none; margin: 10px; padding: 15px; 
            border-radius: 8px; font-weight: bold;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        .alert-danger { background: #b71c1c; border: 2px solid #ff5252; color: #fff; }
        .alert-weak { background: #4a148c; border: 2px solid #ea80fc; color: #fff; }

        /* 4. æ‰‹ç‰Œå€ */
        #hand-area { padding: 5px; min-height: 200px; }
        .card { 
            display: inline-block; width: 70px; height: 96px; margin: 4px; 
            border-radius: 6px; background: #e0e0e0; color: #333; 
            cursor: pointer; position: relative; vertical-align: top;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            font-size: 13px; font-weight: bold; line-height: 96px;
        }
        .card:active { transform: scale(0.95); }
        /* å¡ç‰Œé¡è‰²å®šç¾© */
        .card.atk { background: #ffcdd2; border-bottom: 5px solid #c62828; } /* ç´…ç³» */
        .card.def { background: #c8e6c9; border-bottom: 5px solid #2e7d32; } /* ç¶ ç³»(é–ƒé¿) */
        .card.magic { background: #bbdefb; border-bottom: 5px solid #1565c0; } /* è—ç³»(æ³•è¡“) */
        .card.dark { background: #cfd8dc; border-bottom: 5px solid #455a64; color: #000; } /* æš—ç³» */

        /* 5. è¡Œå‹•æŒ‰éˆ•å€ */
        .action-bar { 
            display: flex; justify-content: space-around; 
            padding: 10px; border-top: 1px solid #444; margin-top: 10px;
        }
        .act-btn {
            width: 30%; padding: 10px; border: none; border-radius: 5px;
            background: #424242; color: white; font-weight: bold;
        }
        .act-btn:active { background: #616161; }

        /* 6. ç›®æ¨™é¸æ“‡å€ (Modal) */
        #target-area { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999; padding-top: 50px;
        }
        .target-list { max-height: 60vh; overflow-y: auto; padding: 0 20px; }
        .target-btn {
            display: block; width: 100%; padding: 15px; margin: 8px 0;
            background: #333; border: 1px solid #666; color: white;
            font-size: 16px; border-radius: 5px;
        }
        .cancel-btn { 
            margin-top: 20px; padding: 10px 40px; background: #666; border: none; color: white; font-size: 16px; border-radius: 20px;
        }

    </style>
</head>
<body>
    <div id="loading">ç³»çµ±é€£ç·šä¸­...</div>

    <!-- 1. è§’è‰²é¸æ“‡ (æ¸¬è©¦ç”¨) -->
    <div id="login-view" style="display:none;">
        <h3>é¸æ“‡æ‰®æ¼”å°è±¡</h3>
        <div id="player-list"></div>
        <p style="color:#777; font-size:12px;">(é–‹ç™¼æ¨¡å¼ï¼šè«‹å…ˆåœ¨ç¾¤çµ„è¼¸å…¥ @æ¸¬è©¦é–‹å±€)</p>
    </div>

    <!-- 2. éŠæˆ²ä¸»ç•«é¢ -->
    <div id="game-view">
        <!-- é ‚éƒ¨æˆ°ç¸¾ -->
        <div class="scoreboard">
            <div class="team-stat RED">
                <div>â¤ï¸ å£«æ°£: <span id="red-morale">15</span></div>
                <div class="gem-container" id="red-gems"></div>
                <div>ğŸ† æ˜Ÿæ¯: <span id="red-grails">0</span></div>
            </div>
            <div class="team-stat BLUE">
                <div>ğŸ’™ å£«æ°£: <span id="blue-morale">15</span></div>
                <div class="gem-container" id="blue-gems"></div>
                <div>ğŸ† æ˜Ÿæ¯: <span id="blue-grails">0</span></div>
            </div>
        </div>

        <!-- ç‹€æ…‹åˆ— -->
        <div class="status-bar">
            <div style="text-align:left;">
                <span id="p-name" style="font-size:18px; font-weight:bold; color:#ffb300;"></span> 
                <span id="p-team" style="font-size:14px;"></span>
                <div id="turn-msg" style="color:#aaa; font-size:12px;">è®€å–ä¸­...</div>
            </div>
            <button class="switch-btn" onclick="logout()">åˆ‡æ›è§’è‰²</button>
        </div>

        <!-- è­¦å‘Šå€ (è¢«æ”»æ“Š/è™›å¼±) -->
        <div id="alert-box">
            <div id="alert-msg"></div>
            <div id="alert-actions" style="margin-top:10px;"></div>
        </div>

        <!-- æ‰‹ç‰Œå€ -->
        <div id="hand-area">
            <div id="hand-list"></div>
        </div>

        <!-- ç‰¹æ®Šè¡Œå‹•å€ -->
        <div class="action-bar" id="special-actions">
            <button class="act-btn" onclick="sendCmd('è³¼è²·')">ğŸ’° è³¼è²·</button>
            <button class="act-btn" onclick="sendCmd('åˆæˆ')">âš—ï¸ åˆæˆ</button>
            <button class="act-btn" onclick="sendCmd('æç…‰')">âš¡ æç…‰</button>
        </div>
    </div>

    <!-- 3. ç›®æ¨™é¸æ“‡å½ˆçª— -->
    <div id="target-area">
        <h3 id="target-title">é¸æ“‡ç›®æ¨™</h3>
        <div class="target-list" id="target-list"></div>
        <button class="cancel-btn" onclick="closeTarget()">å–æ¶ˆ</button>
    </div>

    <script>
        const LIFF_ID = "{{ liff_id }}";
        let currentSimulateId = null;
        let myData = null;
        let selectedCard = "";
        let actionType = ""; // ATTACK, SUPPORT, COUNTER

        // åˆå§‹åŒ–
        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                loadPlayerList();
            } catch (err) {
                document.getElementById('loading').innerText = "LIFF åˆå§‹åŒ–å¤±æ•—: " + err;
            }
        }

        // --- ç™»å…¥æµç¨‹ ---
        function loadPlayerList() {
            fetch('/api/get_all_players')
                .then(r => r.json())
                .then(list => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('login-view').style.display = 'block';
                    document.getElementById('game-view').style.display = 'none';
                    
                    const container = document.getElementById('player-list');
                    container.innerHTML = '';
                    if (list.length === 0) {
                        container.innerHTML = "<p>ç„¡ç©å®¶è³‡æ–™ï¼Œè«‹å…ˆåœ¨ç¾¤çµ„è¼¸å…¥ <b>@æ¸¬è©¦é–‹å±€</b></p>";
                        return;
                    }
                    list.forEach(p => {
                        let btn = document.createElement('div');
                        btn.className = `role-btn ${p.team}`;
                        // é¡¯ç¤ºç‹€æ…‹æ¦‚è¦ (ä¸­æ¯’/è™›å¼±)
                        let buffs = [];
                        if(p.buffs && p.buffs.poison) buffs.push("â˜ ï¸");
                        if(p.buffs && p.buffs.weak) buffs.push("ğŸ’¤");
                        if(p.buffs && p.buffs.shield) buffs.push("ğŸ›¡ï¸");
                        
                        btn.innerHTML = `${p.name} (${p.team}) ${buffs.join('')} <span style="float:right">ğŸƒ${p.hand_count}</span>`;
                        btn.onclick = () => loginAs(p.id);
                        container.appendChild(btn);
                    });
                });
        }

        function loginAs(id) {
            currentSimulateId = id;
            document.getElementById('login-view').style.display = 'none';
            fetchStatus();
        }

        function logout() {
            currentSimulateId = null;
            loadPlayerList();
        }

        // --- è³‡æ–™åŒæ­¥ ---
        function fetchStatus() {
            fetch('/api/my_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ simulate_id: currentSimulateId })
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) { alert(data.error); logout(); return; }
                myData = data;
                renderUI();
            })
            .catch(err => alert("é€£ç·šéŒ¯èª¤: " + err));
        }

        // --- ä»‹é¢æ¸²æŸ“ (Core) ---
        function renderUI() {
            document.getElementById('game-view').style.display = 'block';
            
            // 1. ç©å®¶è³‡è¨Š
            document.getElementById('p-name').innerText = myData.name;
            document.getElementById('p-team').innerText = `(${myData.team})`;
            
            let turnText = myData.is_my_turn ? "â˜… è¼ªåˆ°ä½ çš„å›åˆï¼" : "ç­‰å¾…å…¶ä»–ç©å®¶...";
            if (myData.game_phase === 'RESOLVING' || myData.game_phase === 'RESOLVING_MISSILE') {
                turnText = "âš¡ çµç®—è™•ç†ä¸­...";
            }
            document.getElementById('turn-msg').innerText = turnText;

            // 2. æˆ°ç¸¾æ¿
            const t = myData.teams;
            document.getElementById('red-morale').innerText = t.RED.morale;
            document.getElementById('blue-morale').innerText = t.BLUE.morale;
            document.getElementById('red-grails').innerText = t.RED.grails;
            document.getElementById('blue-grails').innerText = t.BLUE.grails;
            renderGems('red-gems', t.RED.gems);
            renderGems('blue-gems', t.BLUE.gems);

            // 3. ç‹€æ…‹æª¢æŸ¥ (è™›å¼±/è¢«æ”»æ“Š)
            const alertBox = document.getElementById('alert-box');
            const alertMsg = document.getElementById('alert-msg');
            const alertActs = document.getElementById('alert-actions');
            alertBox.style.display = 'none';
            alertActs.innerHTML = '';
            document.getElementById('special-actions').style.display = 'flex'; // é è¨­é¡¯ç¤ºè¡Œå‹•åˆ—

            // æƒ…å¢ƒ A: è™›å¼±é¸æ“‡
            if (myData.game_phase === 'CHOOSING_WEAKNESS' && myData.is_my_turn) {
                alertBox.className = 'alert-weak';
                alertBox.style.display = 'block';
                alertMsg.innerText = "ğŸ’¤ ä½ è™•æ–¼è™›å¼±ç‹€æ…‹ï¼Œå›åˆé–‹å§‹å‰è«‹é¸æ“‡ï¼š";
                
                // éš±è—ä¸€èˆ¬è¡Œå‹•
                document.getElementById('special-actions').style.display = 'none';
                
                alertActs.innerHTML = `
                    <button class="act-btn" style="width:100%; margin-bottom:5px; background:#4a148c;" onclick="sendCmd('@æ‘¸ç‰Œ')">æ‘¸ 3 å¼µç‰Œ (è§£é™¤è™›å¼±)</button>
                    <button class="act-btn" style="width:100%; background:#7b1fa2;" onclick="sendCmd('@è·³é')">è·³éå›åˆ</button>
                `;
            }
            // æƒ…å¢ƒ B: è¢«æ”»æ“Š/é­”å½ˆ
            else if (myData.incoming_attack && myData.incoming_attack.target_id === myData.my_id) {
                alertBox.className = 'alert-danger';
                alertBox.style.display = 'block';
                const inc = myData.incoming_attack;
                
                if (inc.type === 'missile') {
                    alertMsg.innerText = `âš ï¸ ${inc.source_name} ç™¼å°„é­”å½ˆï¼å‚·å®³ ${inc.damage}`;
                } else {
                    alertMsg.innerText = `âš ï¸ ${inc.source_name} ç™¼å‹• [${inc.card_name}] (${inc.element})ï¼`;
                }

                alertActs.innerHTML = `
                    <button class="act-btn" style="width:100%; background:#d32f2f;" onclick="sendCmd('æ‰¿å—')">ç›´æ¥æ‰¿å—å‚·å®³</button>
                `;
            }

            // 4. æ‰‹ç‰Œæ¸²æŸ“
            const list = document.getElementById('hand-list');
            list.innerHTML = '';
            myData.hand.forEach(card => {
                let div = document.createElement('div');
                let type = getCardType(card);
                div.className = `card ${type}`;
                div.innerText = card;
                div.onclick = () => onCardClick(card);
                list.appendChild(div);
            });
        }

        // --- é‚è¼¯åˆ¤æ–· ---
        
        function getCardType(name) {
            if (name.includes('æš—é»‘')) return 'dark'; // æš—å±¬æ€§ç‰¹æ®Šè‰²
            if (name.includes('æ”»æ“Š')) return 'atk';
            if (name.includes('è–å…‰') || name.includes('é–ƒé¿')) return 'def';
            return 'magic'; // è–ç›¾, æ²»ç™’, é­”å½ˆ, ä¸­æ¯’, è™›å¼±
        }

        function renderGems(id, gems) {
            const el = document.getElementById(id);
            el.innerHTML = '';
            gems.forEach(color => {
                let s = document.createElement('span');
                s.className = `gem ${color}`;
                el.appendChild(s);
            });
        }

        function onCardClick(card) {
            selectedCard = card;
            const inc = myData.incoming_attack;
            const isTargeted = (inc && inc.target_id === myData.my_id);

            // --- 1. è¢«é–å®šç‹€æ…‹ (æ‡‰æˆ°) ---
            if (isTargeted) {
                // é­”å½ˆæ‡‰æˆ°
                if (inc.type === 'missile') {
                    if (card === 'é­”å½ˆ' || card === 'è–å…‰' || card === 'è–ç›¾') {
                         if(confirm(`ä½¿ç”¨ [${card}] æ‡‰å°é­”å½ˆï¼Ÿ`)) sendCmd(`æ‰“å‡ºäº† [${card}]`);
                    } else {
                         alert("é­”å½ˆåªèƒ½ç”¨ [é­”å½ˆ/è–å…‰/è–ç›¾] æ‡‰å°ï¼");
                    }
                    return;
                }
                
                // æ™®é€šæ”»æ“Šæ‡‰æˆ°
                if (card === 'è–å…‰') {
                    if(confirm("ä½¿ç”¨è–å…‰æŠµéŠ·ï¼Ÿ")) sendAction(`æ‡‰æˆ° [${card}]`); // è–å…‰ç„¡ç›®æ¨™
                } else {
                    // å…¶ä»–ç‰Œ (åŒå±¬æ€§/æš—å±¬æ€§) éœ€è½‰ç§»
                    if (confirm(`ç”¨ [${card}] æ‡‰æˆ°ä¸¦è½‰ç§»ï¼Ÿ`)) showTargets('COUNTER');
                }
                return;
            }

            // --- 2. ä¸»å‹•å‡ºç‰Œ ---
            if (!myData.is_my_turn) { alert("ä¸æ˜¯ä½ çš„å›åˆ"); return; }
            if (myData.game_phase !== 'ACTION') { alert("ç¾åœ¨ä¸èƒ½å‡ºç‰Œ"); return; }

            // åˆ¤æ–·å¡ç‰Œç”¨é€”
            if (card === 'é­”å½ˆ') {
                if(confirm("ç™¼å°„é­”å½ˆï¼Ÿ(è‡ªå‹•é–å®šä¸‹å®¶)")) sendCmd(`æ‰“å‡ºäº† [${card}]`);
            }
            else if (['è–ç›¾','æ²»ç™’','ä¸­æ¯’','è™›å¼±'].includes(card)) {
                // é€™äº›ç‰Œå¯ä»¥æ”¾ä»»æ„å°è±¡ (è¦å‰‡å…è¨±)
                // è–ç›¾/æ²»ç™’é€šå¸¸å°å‹æ–¹ï¼Œä¸­æ¯’/è™›å¼±å°æ•µæ–¹ï¼Œä½†è®“ç©å®¶é¸æ¯”è¼ƒè‡ªç”±
                showTargets('ANY', card); 
            }
            else if (card.includes('æ”»æ“Š') || card.includes('æš—é»‘')) {
                showTargets('ATTACK', card);
            }
            else if (card.includes('è–å…‰')) {
                alert("è–å…‰é€šå¸¸ç”¨æ–¼æ‡‰æˆ°");
            }
            else {
                alert("æ­¤ç‰Œç„¡æ³•ä¸»å‹•ä½¿ç”¨");
            }
        }

        // --- ç›®æ¨™é¸æ“‡ ---
        function showTargets(mode, cardName) {
            actionType = mode;
            document.getElementById('target-area').style.display = 'block';
            
            let filterFunc = null;
            let title = "";

            if (mode === 'ATTACK') {
                title = `ç”¨ [${cardName}] æ”»æ“Š...`;
                filterFunc = p => p.team !== myData.team; // åªèƒ½æ‰“æ•µäºº
            } else if (mode === 'ANY') {
                title = `å°èª°ä½¿ç”¨ [${cardName}]ï¼Ÿ`;
                filterFunc = p => true; // æ‰€æœ‰äºº
            } else if (mode === 'COUNTER') {
                title = "æ‡‰æˆ°è½‰ç§»çµ¦...";
                // æ’é™¤éšŠå‹ & æ’é™¤æ”»æ“Šä¾†æº
                let src = myData.incoming_attack ? myData.incoming_attack.source_name : "";
                filterFunc = p => p.team !== myData.team && p.name !== src;
            }

            document.getElementById('target-title').innerText = title;
            const list = document.getElementById('target-list');
            list.innerHTML = '';

            let targets = myData.all_players.filter(filterFunc);
            
            if (targets.length === 0) {
                list.innerHTML = "<p style='color:#aaa'>ç„¡åˆæ³•ç›®æ¨™</p>";
            } else {
                targets.forEach(p => {
                    let btn = document.createElement('button');
                    btn.className = 'target-btn';
                    btn.style.borderLeft = `5px solid ${p.team==='RED'?'#d32f2f':'#1976d2'}`;
                    btn.innerText = `${p.name} (${p.team})`;
                    btn.onclick = () => confirmTarget(p.name);
                    list.appendChild(btn);
                });
            }
        }

        function confirmTarget(targetName) {
            let msg = "";
            if (actionType === 'ATTACK') msg = `æ‰“å‡ºäº† [${selectedCard}] æ”»æ“Š ${targetName}`;
            else if (actionType === 'ANY') msg = `æ‰“å‡ºäº† [${selectedCard}] å° ${targetName}`;
            else if (actionType === 'COUNTER') msg = `æ‡‰æˆ° [${selectedCard}] å° ${targetName}`;
            
            sendCmd(msg);
        }

        function closeTarget() {
            document.getElementById('target-area').style.display = 'none';
        }

        function sendAction(text) { // èˆŠç‰ˆç›¸å®¹
            sendCmd(text);
        }

        function sendCmd(text) {
            let prefix = `[${myData.name}] `;
            liff.sendMessages([{ type: 'text', text: prefix + text }])
                .then(() => {
                    closeTarget();
                    liff.closeWindow();
                })
                .catch(err => {
                    alert("ç™¼é€å¤±æ•—ï¼Œè«‹ç¢ºèªæ˜¯åœ¨ LINE App å…§é–‹å•Ÿ: " + err);
                });
        }

        // å•Ÿå‹•
        main();
    </script>
</body>
</html>